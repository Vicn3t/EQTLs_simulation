# eGWAS Multi-Breed Simulation

## Description

This repository contains scripts for a simulation study based on swine transcriptome and variant data generated within the GENE-SWITCH project. The objective is to simulate realistic and complex genotype-expression associations with identical or heterogeneous effects between breeds. These simulated datasets are designed to benchmark and compare different eGWAS tools in their ability to detect such complex patterns of genetic association.

## Data

To run the scripts, you must have a `data` directory in your working folder, structured as follows:

- `1_wgs/`  
  This folder must contain the whole genome sequencing file `wgs_pig_chr18.vcf`, which is required for both the simulation studies and real-data eGWAS analyses.

- `2_rnaseq/`  
  This folder must include the file `LogCPM_counts_GENE-SWitCH_duodenum.txt`, which is used exclusively for the real-data eGWAS analyses.

## Scripts

### Data Preparation

The repository includes several R scripts stored in the `scripts` directory, each dedicated to a specific task:

- `0_data_preparation.Rmd`  
  Extracts, filters, and standardizes raw data. All processed R objects are saved in the `data/3_cleaned_R_data/` directory.

- `1_PCA.Rmd`  
  Performs Principal Component Analysis (PCA) on various combinations of the three swine breeds. The resulting principal components, saved in the `data/3_cleaned_R_data/` directory, are used as covariates in downstream models to correct for population structure.

- `2_GWAS.Rmd`  
  Conducts monogenic eGWAS on real data using the `rrBLUP` package, incorporating the cleaned data and population structure covariates.

### Simulation Study

The `data/simulation_studies` folder contains the core scripts of the simulation pipeline:

#### `0_main_simulation_pipeline.Rmd`

This is the main script for running the simulation study. It requires standardized input data generated by `0_data_preparation.Rmd` and PCA covariates generated by `1_PCA.Rmd`. The script supports several configurable parameters, including:
- the number of sampled SNPs and genes,
- the number of QTLs per gene,
- the proportion of each QTL effect type (e.g. same, different and opposite effect),
- gene heritability values, and more.

The pipeline is divided into two main parts:

1. **Data Simulation**  
   The script samples variants and computes their variant allele frequencies (VAF), simulates QTL effect sizes (betas), and generates synthetic gene expression values for each sampled gene. The resulting simulation objects are saved in the `data/4_simulation_r_data/` directory. Plots illustrating variants allele frequencies are also generated in the `plots/` folder.

   The simulated data is then passed to `Matrix_eQTL` for analysis using various models, with or without principal components (PCs) as covariates. Results are saved in the `data/5_simulation_models_results/` folder. While `Matrix_eQTL` is the only tool currently integrated, the pipeline is designed to accommodate results from other eGWAS methods, provided they follow the expected output format.

2. **Results Interpretation**  

In the `data/05_simulation_models_results/` directory, each subfolder (e.g., `Matrix_eQTL/`) contains result files corresponding to different tested models. For each result file, the pipeline automatically evaluates model performance by comparing detected associations against the known simulated QTLs.

To ensure compatibility with the performance analysis step, all result files must be reformatted into the following standardized structure:  
`gene | variant | pvalue | beta`.

A Bonferroni correction is applied, using a threshold of `1 / (n_genes × n_variants)`.  
If other tools are used, it is strongly recommended to discard their internally adjusted p-values and instead reapply the same Bonferroni filtering on raw p-values to maintain consistency across methods.

#### `1_sim_functions.R`

This file contains a collection of functions used throughout the main simulation script. Centralizing these functions improves modularity and makes the main pipeline more readable.

## Installation

This project requires **R version 4.4.2**.

It is recommended to work within the provided R project for consistency and reproducibility. To do so, simply open the `.Rproj` file included in the repository.

All required R packages are managed with the [`renv`](https://rstudio.github.io/renv/) package. To recreate the development environment on your machine, initialize `renv` using the provided `renv.lock` file:

```r
renv::restore()
```

This will install all necessary packages in a local environment identical to the one used during development.

Additionally, the here package is used to manage relative paths, ensuring all scripts run seamlessly regardless of your system configuration.

## Getting Started

Once the repository is cloned and the environment restored via `renv`, follow these steps to run the simulation workflow:

1. Prepare the `data/` folder as described in the [Data](#data) section.
2. Open the R project file (`.Rproj`) to ensure all paths are correctly resolved.
3. Run the following scripts in this order:
   - `0_data_preparation.Rmd` – prepares cleaned and standardized input data.
   - `1_PCA.Rmd` – computes principal components for population structure correction.
   - `0_main_simulation_pipeline.Rmd` – runs the simulation and association models.
4. Check the output folders (`04_simulation_r_data`, `05_simulation_models_results`, `plots/`) for generated results and figures.

## Project Status

This simulation study was carried out as part of a Master’s thesis internship, which concludes on July 27th. The project will be followed by a PhD thesis focused on the topic:  
**"Integration of large-scale matched multi-omics data."**

## Support

For questions, issues, or further information regarding this repository, please contact:

- Vincent Spinelli — vincentspinelli1@gmail.com  
- Nathalie Vialaneix — nathalie.vialaneix@inrae.fr

## License

This project is licensed under the MIT License.  
See the [LICENSE](./LICENSE) file for details.